<section class="history-page">
  <header class="hero">
    <div class="hero-heading">
      <p class="eyebrow">{{ 'History.Eyebrow' | translate }}</p>
      <h1>{{ 'History.Title' | translate }}</h1>
      <p class="subtitle">
        {{ 'History.Subtitle' | translate }}
      </p>
    </div>

    <div class="hero-stats">
      <article class="stat-card primary">
        <span>{{ 'History.Stats.TotalOffers' | translate }}</span>
        <strong>{{ summaryStats().total }}</strong>
        <small>{{ 'History.Stats.AllTime' | translate }}</small>
      </article>

      <article class="stat-card">
        <span>{{ 'History.Stats.Pending' | translate }}</span>
        <strong>{{ summaryStats().pending }}</strong>
        <small>{{ 'History.Stats.PendingHint' | translate }}</small>
      </article>

      <article class="stat-card">
        <span>{{ 'History.Stats.Accepted' | translate }}</span>
        <strong>{{ summaryStats().accepted }}</strong>
        <small>{{ 'History.Stats.AcceptedHint' | translate }}</small>
      </article>

      <article class="stat-card">
        <span>{{ 'History.Stats.Rejected' | translate }}</span>
        <strong>{{ summaryStats().rejected }}</strong>
        <small>{{ 'History.Stats.RejectedHint' | translate }}</small>
      </article>

      <article class="stat-card">
        <span>{{ 'History.Stats.WithdrawnExpired' | translate }}</span>
        <strong>{{ summaryStats().withdrawn + summaryStats().expired }}</strong>
        <small>{{ 'History.Stats.WithdrawnExpiredHint' | translate }}</small>
      </article>
    </div>

    <div class="hero-actions">
      <button
        class="btn btn-secondary"
        type="button"
        (click)="refresh()"
        [disabled]="isLoading()"
      >
        {{ 'History.Actions.Refresh' | translate }}
      </button>
    </div>
  </header>

  <!-- Filters -->
  <section class="filters-card">
    <div class="filters-toolbar">
      <label class="filter-control">
        <span>{{ 'History.Filters.OfferStatus' | translate }}</span>
        <select
          class="status-select"
          [value]="statusFilter()"
          (change)="onStatusChange($any($event.target).value)"
        >
          @for (option of statusOptions; track option.value) {
            <option [value]="option.value">
              {{ option.label | translate }}
            </option>
          }
        </select>
      </label>

      <div class="filter-summary">
        <strong>{{ filteredRecords().length }}</strong>
        <span>{{ 'History.Filters.Matches' | translate }}</span>
      </div>
    </div>
  </section>

  <!-- Content -->
  <section class="content">
    @if (isLoading()) {
      <div class="records-grid">
        @for (_ of skeletonPlaceholders; track $index) {
          <article class="history-card skeleton">
            <div class="skeleton-line w-60"></div>
            <div class="skeleton-line w-90"></div>
            <div class="skeleton-grid">
              <span class="skeleton-pill"></span>
              <span class="skeleton-pill"></span>
              <span class="skeleton-pill"></span>
            </div>
          </article>
        }
      </div>
    }

    @else if (!filteredRecords().length && hasLoaded()) {
      <div class="state state-empty">
        <h3>{{ 'History.Empty.Title' | translate }}</h3>
        <p>{{ 'History.Empty.Description' | translate }}</p>
        <button
          class="btn btn-secondary"
          type="button"
          (click)="onStatusChange('all')"
        >
          {{ 'History.Filters.ShowAll' | translate }}
        </button>
      </div>
    }

    @else {
      <div class="records-grid">
        @for (record of filteredRecords(); track trackByOfferId($index, record)) {
          <article class="history-card">
            <div class="card-head">
              <div>
                <span
                  class="chip"
                  [class]="getRequestStatusClass(record.request?.status)"
                >
                  {{ getRequestStatusLabel(record.request?.status) }}
                </span>

                <a
                  class="text-black"
                  [routerLink]="[
                    '/service-request-details',
                    record.request?.serviceRequestId
                  ]"
                >
                  <h3>
                    {{
                      record.request?.title
                        ?? ('History.Fallbacks.RequestUnavailable' | translate)
                    }}
                  </h3>
                </a>

                <p>
                  {{
                    record.request?.description
                      ?? ('History.Fallbacks.DetailsUnavailable' | translate)
                  }}
                </p>
              </div>

              <div class="offer-status-block">
                <span class="pill-label">
                  {{ 'History.Labels.OfferStatus' | translate }}
                </span>
                <span [class]="getOfferStatusClass(record.offer.status)">
                  {{ getOfferStatusLabel(record.offer.status) }}
                </span>
              </div>
            </div>

            <div class="card-body">
              <div class="details-grid">
                <div class="detail">
                  <span>{{ 'History.Labels.Craft' | translate }}</span>
                  <strong>
                    {{
                      record.request?.craftName
                        ?? ('History.Fallbacks.GeneralServices' | translate)
                    }}
                  </strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.Customer' | translate }}</span>
                  <strong>
                    {{
                      record.request?.customerName
                        ?? ('History.Fallbacks.HiddenCustomer' | translate)
                    }}
                  </strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.Budget' | translate }}</span>
                  <strong>{{ formatCurrency(record.request?.customerBudget) }}</strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.CityArea' | translate }}</span>
                  <strong>{{ getLocationLabel(record.request) }}</strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.Address' | translate }}</span>
                  <strong>
                    {{
                      record.request?.address
                        ?? ('History.Fallbacks.AddressNotShared' | translate)
                    }}
                  </strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.RequestCreated' | translate }}</span>
                  <strong>{{ formatDateTime(record.request?.createdAt) }}</strong>
                </div>

                <div class="detail">
                  <span>{{ 'History.Labels.Expires' | translate }}</span>
                  <strong>{{ formatDateTime(record.request?.expiresAt) }}</strong>
                </div>
              </div>

              <div class="offer-summary">
                <div class="offer-meta">
                  <div>
                    <span>{{ 'History.Labels.OfferSubmitted' | translate }}</span>
                    <strong>{{ formatDateTime(record.offer.createdAt) }}</strong>
                  </div>

                  <div>
                    <span>{{ 'History.Labels.OfferedPrice' | translate }}</span>
                    <strong>{{ formatCurrency(record.offer.offeredPrice) }}</strong>
                  </div>

                  <div>
                    <span>{{ 'History.Labels.Availability' | translate }}</span>
                    <strong>
                      {{ formatDate(record.offer.preferredDate) }}
                      â€“
                      {{ formatDate(record.offer.preferredTimeSlot) }}
                    </strong>
                  </div>

                  <div>
                    <span>{{ 'History.Labels.Duration' | translate }}</span>
                    <strong>
                      {{ formatDuration(record.offer.estimatedDurationMinutes) }}
                    </strong>
                  </div>
                </div>

                <p class="offer-description">
                  {{ record.offer.description }}
                </p>

                @if (record.offer.rejectionReason) {
                  <div class="alert warning">
                    <strong>
                      {{ 'History.Labels.ReasonProvided' | translate }}
                    </strong>
                    <span>{{ record.offer.rejectionReason }}</span>
                  </div>
                }
              </div>
            </div>
          </article>
        }
      </div>
    }
  </section>
</section>
