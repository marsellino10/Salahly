<section class="complete-profile-page">
  <header class="page-hero glass-panel">
    <div class="hero-copy">
      <p class="eyebrow">{{ 'CompleteProfile.Hero.Eyebrow' | translate }}</p>
      <div class="hero-title">
        <h1>{{ 'CompleteProfile.Hero.Title' | translate }}</h1>
        <span class="status-pill" [class.success]="hasExistingProfile">
          <i class="bi" [class.bi-patch-check-fill]="hasExistingProfile" [class.bi-hourglass-split]="!hasExistingProfile"></i>
          {{ (hasExistingProfile ? 'CompleteProfile.Hero.Status.InReview' : 'CompleteProfile.Hero.Status.FinishSetup') | translate }}
        </span>
      </div>
      <p>{{ 'CompleteProfile.Hero.Description' | translate }}</p>
      <ul class="hero-highlights">
        <li><i class="bi bi-check-circle"></i> {{ 'CompleteProfile.Hero.Highlights.Identity' | translate }}</li>
        <li><i class="bi bi-geo-alt"></i> {{ 'CompleteProfile.Hero.Highlights.Radius' | translate }}</li>
        <li><i class="bi bi-broadcast"></i> {{ 'CompleteProfile.Hero.Highlights.Story' | translate }}</li>
      </ul>
    </div>
    <div class="hero-progress">
      <div class="progress-stats">
        <span class="progress-value">{{ progressValue }}%</span>
        <small>{{ 'CompleteProfile.Hero.ProgressStrength' | translate }}</small>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressValue"></div>
      </div>
      <p class="progress-hint">{{ 'CompleteProfile.Hero.ProgressHint' | translate }}</p>
    </div>
  </header>

  <div *ngIf="submissionMessage" class="alert" [class.success]="submissionMessage.type === 'success'">
    <i class="bi" [class.bi-check2-circle]="submissionMessage.type === 'success'" [class.bi-exclamation-triangle]="submissionMessage.type === 'error'"></i>
    <span>{{ submissionMessage.text }}</span>
    <button type="button" class="icon-btn" (click)="clearSubmissionMessage()">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <div class="profile-layout" [class.is-loading]="isLoadingProfile">
    <aside class="side-panel">
      <div class="card avatar-card">
        <div class="avatar-shell" [class.has-image]="profileImagePreview || existingProfileImageUrl">
          <img *ngIf="profileImagePreview" [src]="profileImagePreview" [attr.alt]="('CompleteProfile.AvatarCard.ProfilePreviewAlt' | translate)" />
          <img *ngIf="!profileImagePreview && existingProfileImageUrl" [src]="existingProfileImageUrl" [attr.alt]="('CompleteProfile.AvatarCard.CurrentProfileAlt' | translate)" />
          <div *ngIf="!profileImagePreview && !existingProfileImageUrl" class="avatar-placeholder">
            <i class="bi bi-person-bounding-box"></i>
            <span>{{ 'CompleteProfile.AvatarCard.Placeholder' | translate }}</span>
          </div>
        </div>
        <label class="upload-btn">
          <input type="file" accept="image/*" (change)="onImageSelected($event)" />
          <i class="bi bi-upload"></i>
          <span>{{ (selectedProfileImage ? 'CompleteProfile.AvatarCard.ChangePhoto' : 'CompleteProfile.AvatarCard.UploadPhotoCta') | translate }}</span>
        </label>
        <small>{{ 'CompleteProfile.AvatarCard.HelperText' | translate }}</small>
      </div>

      <div class="card steps-card">
        <div class="card-head">
          <p class="eyebrow mb-1">{{ 'CompleteProfile.Checklist.Eyebrow' | translate }}</p>
          <h5>{{ 'CompleteProfile.Checklist.Title' | translate }}</h5>
        </div>
        <ul class="step-list">
          <li *ngFor="let step of progressSteps" [class.completed]="step.completed">
            <i class="bi" [class.bi-check-circle-fill]="step.completed" [class.bi-circle]="!step.completed"></i>
            <div>
              <p>{{ step.labelKey | translate }}</p>
              <small>{{ (step.completed ? 'CompleteProfile.Checklist.Done' : 'CompleteProfile.Checklist.Todo') | translate }}</small>
            </div>
          </li>
        </ul>
      </div>

      <div class="card tips-card">
        <h6>{{ 'CompleteProfile.Tips.Title' | translate }}</h6>
        <ul>
          <li>{{ 'CompleteProfile.Tips.Rate' | translate }}</li>
          <li>{{ 'CompleteProfile.Tips.Bio' | translate }}</li>
          <li>{{ 'CompleteProfile.Tips.Areas' | translate }}</li>
        </ul>
      </div>
    </aside>

    <form class="profile-form" [formGroup]="profileForm" (ngSubmit)="onSubmit()">
      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">{{ 'CompleteProfile.Form.StepLabel' | translate:{ step: 1 } }}</p>
            <h4>{{ 'CompleteProfile.Form.ProfileBasicsTitle' | translate }}</h4>
          </div>
          <span class="chip">{{ 'CompleteProfile.Form.RequiredChip' | translate }}</span>
        </div>

        <div class="field-grid">
          <div class="form-field" [class.invalid]="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched">
            <label>{{ 'CompleteProfile.Form.Fields.FullNameLabel' | translate }}</label>
            <div class="input-shell">
              <i class="bi bi-person"></i>
              <input type="text" formControlName="fullName" [placeholder]="'CompleteProfile.Form.Fields.FullNamePlaceholder' | translate" />
            </div>
            <small *ngIf="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched" class="error-text">{{ 'CompleteProfile.Form.Fields.FullNameError' | translate }}</small>
          </div>

          <div class="form-field" [class.invalid]="profileForm.get('craftId')?.invalid && profileForm.get('craftId')?.touched">
            <label>{{ 'CompleteProfile.Form.Fields.CraftLabel' | translate }}</label>
            <div class="input-shell">
              <i class="bi bi-lightning"></i>
              <select formControlName="craftId">
                <option [ngValue]="null" disabled>{{ 'CompleteProfile.Form.Fields.CraftPlaceholder' | translate }}</option>
                <option *ngFor="let craft of crafts" [ngValue]="craft.id">{{ (this._translate.currentLang === 'ar') ? craft.nameAr : craft.name}}</option>
              </select>
            </div>
            <small *ngIf="profileForm.get('craftId')?.invalid && profileForm.get('craftId')?.touched" class="error-text">{{ 'CompleteProfile.Form.Fields.CraftError' | translate }}</small>
          </div>
        </div>
      </section>

      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">{{ 'CompleteProfile.Form.StepLabel' | translate:{ step: 2 } }}</p>
            <h4>{{ 'CompleteProfile.Form.ExperienceStoryTitle' | translate }}</h4>
          </div>
          <span class="chip muted">{{ 'CompleteProfile.Form.CredibilityChip' | translate }}</span>
        </div>

        <div class="field-grid three-cols">
          <div class="form-field" [class.invalid]="profileForm.get('hourlyRate')?.invalid && profileForm.get('hourlyRate')?.touched">
            <label>{{ 'CompleteProfile.Form.Fields.HourlyRateLabel' | translate }}</label>
            <div class="input-shell">
              <i class="bi bi-cash"></i>
              <input type="number" min="20" max="5000" formControlName="hourlyRate" [placeholder]="'CompleteProfile.Form.Fields.HourlyRatePlaceholder' | translate" />
            </div>
            <small class="hint">{{ 'CompleteProfile.Form.Fields.HourlyRateHint' | translate }}</small>
            <small *ngIf="profileForm.get('hourlyRate')?.invalid && profileForm.get('hourlyRate')?.touched" class="error-text">{{ 'CompleteProfile.Form.Fields.HourlyRateError' | translate }}</small>
          </div>

          <div class="form-field" [class.invalid]="profileForm.get('yearsOfExperience')?.invalid && profileForm.get('yearsOfExperience')?.touched">
            <label>{{ 'CompleteProfile.Form.Fields.YearsLabel' | translate }}</label>
            <div class="input-shell">
              <i class="bi bi-award"></i>
              <input type="number" min="0" max="60" formControlName="yearsOfExperience" [placeholder]="'CompleteProfile.Form.Fields.YearsPlaceholder' | translate" />
            </div>
            <small *ngIf="profileForm.get('yearsOfExperience')?.invalid && profileForm.get('yearsOfExperience')?.touched" class="error-text">{{ 'CompleteProfile.Form.Fields.YearsError' | translate }}</small>
          </div>

          <div class="form-field textarea-field" [class.invalid]="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched">
            <label>{{ 'CompleteProfile.Form.Fields.BioLabel' | translate }}</label>
            <div class="input-shell textarea">
              <textarea formControlName="bio" rows="4" [placeholder]="'CompleteProfile.Form.Fields.BioPlaceholder' | translate"></textarea>
            </div>
            <small class="hint">{{ 'CompleteProfile.Form.Fields.BioHint' | translate }}</small>
            <small *ngIf="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched" class="error-text">{{ 'CompleteProfile.Form.Fields.BioError' | translate }}</small>
          </div>
        </div>
      </section>

      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">{{ 'CompleteProfile.Form.StepLabel' | translate:{ step: 3 } }}</p>
            <h4>{{ 'CompleteProfile.Form.ServiceCoverageTitle' | translate }}</h4>
          </div>
          <span class="chip">{{ serviceAreasControls.length }}/{{ maxServiceAreas }} {{ 'CompleteProfile.ServiceAreas.AreasLabel' | translate }}</span>
        </div>

        <div class="service-areas" formArrayName="serviceAreas">
          <div *ngFor="let areaGroup of serviceAreasControls.controls; let i = index" class="service-area-card" [formGroupName]="i">
            <div class="area-header">
              <div>
                <p class="title">{{ 'CompleteProfile.ServiceAreas.CardTitle' | translate:{ index: i + 1 } }}</p>
                <small>{{ displayAreaLabel(areaGroup.value?.areaId ?? null) }}</small>
              </div>
              <button
                type="button"
                class="icon-btn"
                (click)="removeServiceArea(i)"
                [disabled]="serviceAreasControls.length === 1"
                [attr.aria-label]="'CompleteProfile.ServiceAreas.RemoveAreaAria' | translate"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>

            <div class="field-grid">
              <div class="form-field" [class.invalid]="areaGroup.get('areaId')?.invalid && areaGroup.get('areaId')?.touched">
                <label>{{ 'CompleteProfile.ServiceAreas.RegionCityLabel' | translate }}</label>
                <div class="input-shell">
                  <i class="bi bi-geo"></i>
                  <select formControlName="areaId">
                    <option [ngValue]="null" disabled>{{ 'CompleteProfile.ServiceAreas.SelectAreaPlaceholder' | translate }}</option>
                    <ng-container *ngFor="let group of groupedAreas">
                      <optgroup [label]="group.region">
                        <option *ngFor="let area of group.areas" [ngValue]="area.id" [disabled]="isAreaSelected(area.id, i)">
                          {{ area.city }}
                        </option>
                      </optgroup>
                    </ng-container>
                  </select>
                </div>
                <small *ngIf="areaGroup.get('areaId')?.invalid && areaGroup.get('areaId')?.touched" class="error-text">{{ 'CompleteProfile.ServiceAreas.AreaError' | translate }}</small>
              </div>

              <div class="form-field" [class.invalid]="areaGroup.get('serviceRadiusKm')?.invalid && areaGroup.get('serviceRadiusKm')?.touched">
                <label>{{ 'CompleteProfile.ServiceAreas.RadiusLabel' | translate }}</label>
                <div class="radius-control">
                  <input type="range" min="5" max="80" formControlName="serviceRadiusKm" />
                  <div class="radius-meta">
                    <span>{{ 'CompleteProfile.ServiceAreas.DistanceLabel' | translate:{ value: areaGroup.get('serviceRadiusKm')?.value || 10 } }}</span>
                    <small>{{ 'CompleteProfile.ServiceAreas.Recommendation' | translate }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <small *ngIf="serviceAreasTouched" class="error-text">{{ 'CompleteProfile.ServiceAreas.MinAreaError' | translate }}</small>

          <button type="button" class="btn ghost w-100" (click)="addServiceArea()" [disabled]="!canAddMoreAreas">
            <i class="bi bi-plus-circle"></i>
            <span>{{ (canAddMoreAreas ? 'CompleteProfile.ServiceAreas.AddButton' : 'CompleteProfile.ServiceAreas.MaxButton') | translate }}</span>
          </button>
        </div>
      </section>

      <div class="form-actions">
        <button class="btn primary" type="submit" [disabled]="isSubmitting || isLoadingProfile">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status"></span>
          <span>{{ (hasExistingProfile ? 'CompleteProfile.Buttons.PrimaryUpdate' : 'CompleteProfile.Buttons.PrimaryPublish') | translate }}</span>
        </button>
      </div>
    </form>

    <div *ngIf="isLoadingProfile" class="loading-overlay">
      <div class="loader"></div>
      <p>{{ 'CompleteProfile.Loading.Message' | translate }}</p>
    </div>
  </div>
</section>
