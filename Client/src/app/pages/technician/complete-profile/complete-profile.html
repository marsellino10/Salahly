<section class="complete-profile-page">
  <header class="page-hero glass-panel">
    <div class="hero-copy">
      <p class="eyebrow">You're one step away</p>
      <div class="hero-title">
        <h1>Complete your technician profile</h1>
        <span class="status-pill" [class.success]="hasExistingProfile">
          <i class="bi" [class.bi-patch-check-fill]="hasExistingProfile" [class.bi-hourglass-split]="!hasExistingProfile"></i>
          {{ hasExistingProfile ? 'Profile in review' : 'Finish setup' }}
        </span>
      </div>
      <p>Showcase your expertise, define where you serve, and let customers book you with confidence.</p>
      <ul class="hero-highlights">
        <li><i class="bi bi-check-circle"></i> Verified identity & credentials</li>
        <li><i class="bi bi-geo-alt"></i> Flexible service radius per city</li>
        <li><i class="bi bi-broadcast"></i> Highlight your story & experience</li>
      </ul>
    </div>
    <div class="hero-progress">
      <div class="progress-stats">
        <span class="progress-value">{{ progressValue }}%</span>
        <small>Profile strength</small>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressValue"></div>
      </div>
      <p class="progress-hint">Complete every section for the best ranking in search results.</p>
    </div>
  </header>

  <div *ngIf="submissionMessage" class="alert" [class.success]="submissionMessage.type === 'success'">
    <i class="bi" [class.bi-check2-circle]="submissionMessage.type === 'success'" [class.bi-exclamation-triangle]="submissionMessage.type === 'error'"></i>
    <span>{{ submissionMessage.text }}</span>
    <button type="button" class="icon-btn" (click)="clearSubmissionMessage()">
      <i class="bi bi-x"></i>
    </button>
  </div>

  <div class="profile-layout" [class.is-loading]="isLoadingProfile">
    <aside class="side-panel">
      <div class="card avatar-card">
        <div class="avatar-shell" [class.has-image]="profileImagePreview || existingProfileImageUrl">
          <img *ngIf="profileImagePreview" [src]="profileImagePreview" alt="Profile preview" />
          <img *ngIf="!profileImagePreview && existingProfileImageUrl" [src]="existingProfileImageUrl" alt="Current profile" />
          <div *ngIf="!profileImagePreview && !existingProfileImageUrl" class="avatar-placeholder">
            <i class="bi bi-person-bounding-box"></i>
            <span>Upload photo</span>
          </div>
        </div>
        <label class="upload-btn">
          <input type="file" accept="image/*" (change)="onImageSelected($event)" />
          <i class="bi bi-upload"></i>
          <span>{{ selectedProfileImage ? 'Change photo' : 'Upload profile photo' }}</span>
        </label>
        <small>High quality JPG or PNG, max 3MB.</small>
      </div>

      <div class="card steps-card">
        <div class="card-head">
          <p class="eyebrow mb-1">Completion checklist</p>
          <h5>Progress overview</h5>
        </div>
        <ul class="step-list">
          <li *ngFor="let step of progressSteps" [class.completed]="step.completed">
            <i class="bi" [class.bi-check-circle-fill]="step.completed" [class.bi-circle]="!step.completed"></i>
            <div>
              <p>{{ step.label }}</p>
              <small>{{ step.completed ? 'Looks great!' : 'Still needs your attention' }}</small>
            </div>
          </li>
        </ul>
      </div>

      <div class="card tips-card">
        <h6>Pro tips</h6>
        <ul>
          <li>Keep hourly rate aligned with your expertise.</li>
          <li>Use the bio to highlight certifications & specialties.</li>
          <li>Add areas where you can arrive in under 60 minutes.</li>
        </ul>
      </div>
    </aside>

    <form class="profile-form" [formGroup]="profileForm" (ngSubmit)="onSubmit()">
      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">Step 1</p>
            <h4>Profile basics</h4>
          </div>
          <span class="chip">Required</span>
        </div>

        <div class="field-grid">
          <div class="form-field" [class.invalid]="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched">
            <label>Full name</label>
            <div class="input-shell">
              <i class="bi bi-person"></i>
              <input type="text" formControlName="fullName" placeholder="e.g. Ahmed Samir" />
            </div>
            <small *ngIf="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched" class="error-text">Please enter your legal name.</small>
          </div>

          <div class="form-field" [class.invalid]="profileForm.get('craftId')?.invalid && profileForm.get('craftId')?.touched">
            <label>Primary craft</label>
            <div class="input-shell">
              <i class="bi bi-lightning"></i>
              <select formControlName="craftId">
                <option [ngValue]="null" disabled>Select your specialty</option>
                <option *ngFor="let craft of crafts" [ngValue]="craft.id">{{ craft.name }}</option>
              </select>
            </div>
            <small *ngIf="profileForm.get('craftId')?.invalid && profileForm.get('craftId')?.touched" class="error-text">Please choose your main service.</small>
          </div>
        </div>
      </section>

      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">Step 2</p>
            <h4>Experience & story</h4>
          </div>
          <span class="chip muted">Boost credibility</span>
        </div>

        <div class="field-grid three-cols">
          <div class="form-field" [class.invalid]="profileForm.get('hourlyRate')?.invalid && profileForm.get('hourlyRate')?.touched">
            <label>Hourly rate (EGP)</label>
            <div class="input-shell">
              <i class="bi bi-cash"></i>
              <input type="number" min="20" max="5000" formControlName="hourlyRate" placeholder="350" />
            </div>
            <small class="hint">Customers can still send custom quotes.</small>
            <small *ngIf="profileForm.get('hourlyRate')?.invalid && profileForm.get('hourlyRate')?.touched" class="error-text">Enter a realistic hourly rate.</small>
          </div>

          <div class="form-field" [class.invalid]="profileForm.get('yearsOfExperience')?.invalid && profileForm.get('yearsOfExperience')?.touched">
            <label>Experience (years)</label>
            <div class="input-shell">
              <i class="bi bi-award"></i>
              <input type="number" min="0" max="60" formControlName="yearsOfExperience" placeholder="8" />
            </div>
            <small *ngIf="profileForm.get('yearsOfExperience')?.invalid && profileForm.get('yearsOfExperience')?.touched" class="error-text">Provide a value between 0 and 60.</small>
          </div>

          <div class="form-field textarea-field" [class.invalid]="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched">
            <label>Bio & story</label>
            <div class="input-shell textarea">
              <textarea formControlName="bio" rows="4" placeholder="Share certifications, notable projects, languages, or guarantees"></textarea>
            </div>
            <small class="hint">Up to 600 characters.</small>
            <small *ngIf="profileForm.get('bio')?.invalid && profileForm.get('bio')?.touched" class="error-text">Tell customers what makes you unique.</small>
          </div>
        </div>
      </section>

      <section class="card form-section">
        <div class="section-head">
          <div>
            <p class="eyebrow mb-1">Step 3</p>
            <h4>Service coverage</h4>
          </div>
          <span class="chip">{{ serviceAreasControls.length }}/{{ maxServiceAreas }} areas</span>
        </div>

        <div class="service-areas" formArrayName="serviceAreas">
          <div *ngFor="let areaGroup of serviceAreasControls.controls; let i = index" class="service-area-card" [formGroupName]="i">
            <div class="area-header">
              <div>
                <p class="title">Area {{ i + 1 }}</p>
                <small>{{ displayAreaLabel(areaGroup.value?.areaId ?? null) }}</small>
              </div>
              <button
                type="button"
                class="icon-btn"
                (click)="removeServiceArea(i)"
                [disabled]="serviceAreasControls.length === 1"
                aria-label="Remove area"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>

            <div class="field-grid">
              <div class="form-field" [class.invalid]="areaGroup.get('areaId')?.invalid && areaGroup.get('areaId')?.touched">
                <label>Region & city</label>
                <div class="input-shell">
                  <i class="bi bi-geo"></i>
                  <select formControlName="areaId">
                    <option [ngValue]="null" disabled>Select an area</option>
                    <ng-container *ngFor="let group of groupedAreas">
                      <optgroup [label]="group.region">
                        <option *ngFor="let area of group.areas" [ngValue]="area.id" [disabled]="isAreaSelected(area.id, i)">
                          {{ area.city }}
                        </option>
                      </optgroup>
                    </ng-container>
                  </select>
                </div>
                <small *ngIf="areaGroup.get('areaId')?.invalid && areaGroup.get('areaId')?.touched" class="error-text">Choose where you can serve.</small>
              </div>

              <div class="form-field" [class.invalid]="areaGroup.get('serviceRadiusKm')?.invalid && areaGroup.get('serviceRadiusKm')?.touched">
                <label>Service radius (km)</label>
                <div class="radius-control">
                  <input type="range" min="5" max="80" formControlName="serviceRadiusKm" />
                  <div class="radius-meta">
                    <span>{{ areaGroup.get('serviceRadiusKm')?.value || 10 }} km</span>
                    <small>Recommended: 15-35 km</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <small *ngIf="serviceAreasTouched" class="error-text">Add at least one service area to go live.</small>

          <button type="button" class="btn ghost w-100" (click)="addServiceArea()" [disabled]="!canAddMoreAreas">
            <i class="bi bi-plus-circle"></i>
            <span>{{ canAddMoreAreas ? 'Add another service area' : 'Maximum areas reached' }}</span>
          </button>
        </div>
      </section>

      <div class="form-actions">
        <button class="btn primary" type="submit" [disabled]="isSubmitting || isLoadingProfile">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status"></span>
          <span>{{ hasExistingProfile ? 'Update profile' : 'Publish profile' }}</span>
        </button>
      </div>
    </form>

    <div *ngIf="isLoadingProfile" class="loading-overlay">
      <div class="loader"></div>
      <p>Loading your profile...</p>
    </div>
  </div>
</section>
