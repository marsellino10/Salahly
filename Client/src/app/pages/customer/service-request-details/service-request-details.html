<div class="details-page">
  <div class="top-nav">
    <button type="button" class="ghost-btn" (click)="navigateBack()">
      <i class="bi bi-arrow-left"></i>
      {{ 'ServiceRequestDetails.TopNav.Back' | translate }}
    </button>

    <span
      class="status-chip"
      *ngIf="request() as data"
      [style.background]="getStatusStyle(data.status).bg"
      [style.color]="getStatusStyle(data.status).text"
    >
      {{ getRequestStatusLabel(data.status) }}
    </span>
  </div>

  <div class="banner" *ngIf="actionBanner() as banner" [ngClass]="banner.type">
    <div>
      <p class="eyebrow">{{ 'ServiceRequestDetails.Banner.Title' | translate }}</p>
      <p class="banner-message">{{ banner.message }}</p>
    </div>
    <button type="button" class="ghost-btn icon" (click)="dismissBanner()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <section class="hero-panel glass-panel">
    <ng-container *ngIf="isRequestLoading(); else heroLoaded">
      <div class="hero-skeleton">
        <div class="skeleton-line w-40"></div>
        <div class="skeleton-line w-80"></div>
        <div class="skeleton-line w-65"></div>
        <div class="skeleton-card-grid">
          <div class="skeleton-card" *ngFor="let _ of [0, 1, 2, 3]"></div>
        </div>
      </div>
    </ng-container>

    <ng-template #heroLoaded>
      <ng-container *ngIf="requestError() as err; else heroContent">
        <div class="error-state">
          <div>
            <h3>{{ 'ServiceRequestDetails.Hero.ErrorTitle' | translate }}</h3>
            <p>{{ err }}</p>
          </div>
          <button type="button" class="primary-btn" (click)="loadRequest()">
            {{ 'ServiceRequestDetails.Buttons.Retry' | translate }}
          </button>
        </div>
      </ng-container>
    </ng-template>

    <ng-template #heroContent>
      <ng-container *ngIf="request() as requestData; else heroEmpty">
        <div class="hero-grid">
          <div class="hero-copy">
            <p class="eyebrow">{{ requestData.craftName || ('ServiceRequestDetails.Hero.CraftFallback' | translate) }}</p>
            <div class="title-row">
              <h1>{{ requestData.title }}</h1>
              <span
                class="status-chip"
                [style.background]="getStatusStyle(requestData.status).bg"
                [style.color]="getStatusStyle(requestData.status).text"
              >
                {{ getRequestStatusLabel(requestData.status) }}
              </span>
            </div>
            <p class="lead">{{ requestData.description }}</p>

            <div class="meta-grid">
              <article class="meta-card" *ngFor="let item of requestMeta()">
                <i class="bi" [ngClass]="item.icon"></i>
                <div>
                  <p class="label">{{ item.labelKey | translate }}</p>
                  <p class="value">{{ item.value }}</p>
                </div>
              </article>
            </div>

            <div class="address-section" *ngIf="showAddress">
              <label>{{ 'ServiceRequestDetails.Meta.AddressLabel' | translate }}</label>
              <p>{{ request()?.address }}</p>
            </div>

            <div class="timestamp-row">
              <span>
                <i class="bi bi-clock-history"></i>
                {{ 'ServiceRequestDetails.Meta.CreatedLabel' | translate }} {{ formatDateTime(requestData.createdAt) }}
              </span>
              <span>
                <i class="bi bi-hourglass-split"></i>
                {{ 'ServiceRequestDetails.Meta.ExpiresLabel' | translate }} {{ formatDateTime(requestData.expiresAt) }}
              </span>
            </div>

            <div class="hero-actions" *ngIf="isCustomer">
              <button type="button" class="ghost-btn" (click)="openEditModal()">
                <i class="bi bi-pencil-square"></i>
                {{ 'ServiceRequestDetails.Buttons.EditRequest' | translate }}
              </button>
              <button type="button" class="danger-btn" (click)="promptDelete()">
                <i class="bi bi-trash"></i>
                {{ 'ServiceRequestDetails.Buttons.DeleteRequest' | translate }}
              </button>
              <button type="button" class="primary-btn" (click)="completeRequest()" *ngIf="canCompleteRequest">
                <i class="bi bi-check-circle"></i>
                Complete Request
              </button>
            </div>
          </div>

          <div class="hero-media">
            <div class="media-card">
              @if(requestImages().length) {
                <owl-carousel-o [options]="heroCarouselOptions">
                  @for(image of requestImages(); track trackImage($index, image)) {
                    <ng-template carouselSlide>
                      <img [src]="image" [alt]="requestData.title" loading="lazy" />
                    </ng-template>
                  }
                </owl-carousel-o>
              } @else {
                <div class="media-fallback">
                  <i class="bi bi-image"></i>
                  <p>{{ 'ServiceRequestDetails.Hero.MediaFallback' | translate }}</p>
                </div>
              }
            </div>
          </div>
        </div>
      </ng-container>
    </ng-template>

    <ng-template #heroEmpty>
      <div class="empty-panel">
        <div class="empty-icon">
          <i class="bi bi-journal-text"></i>
        </div>
        <h3>{{ 'ServiceRequestDetails.Hero.EmptyTitle' | translate }}</h3>
        <p>{{ 'ServiceRequestDetails.Hero.EmptyDescription' | translate }}</p>
      </div>
    </ng-template>
  </section>

  <section class="offers-panel glass-panel" *ngIf="isCustomer">
    <div class="section-head">
      <div>
        <p class="eyebrow">{{ 'ServiceRequestDetails.Offers.Title' | translate }}</p>
        <h2>
          {{ 'ServiceRequestDetails.Offers.Count' | translate:{ count: offers().length } }}
        </h2>
      </div>
      <button type="button" class="ghost-btn" (click)="loadOffers()" [disabled]="isOffersLoading()">
        <i class="bi bi-arrow-clockwise"></i>
        {{ 'ServiceRequestDetails.Buttons.RefreshOffers' | translate }}
      </button>
    </div>

    <ng-container *ngIf="isOffersLoading(); else offersLoaded">
      <div class="offers-skeleton">
        <article class="skeleton-card" *ngFor="let _ of [0, 1, 2]"></article>
      </div>
    </ng-container>

    <ng-template #offersLoaded>
      <ng-container *ngIf="offersError() as offersErr; else offersContent">
        <div class="error-state">
          <div>
            <h3>{{ 'ServiceRequestDetails.Offers.ErrorTitle' | translate }}</h3>
            <p>{{ offersErr }}</p>
          </div>
          <button type="button" class="primary-btn" (click)="loadOffers()">
            {{ 'ServiceRequestDetails.Buttons.Retry' | translate }}
          </button>
        </div>
      </ng-container>
    </ng-template>

    <ng-template #offersContent>
      <ng-container *ngIf="offers().length; else noOffers">
        <div class="offers-list">
          <article class="offer-card" *ngFor="let offer of offers(); trackBy: trackByOfferId">
            <div class="offer-header">
              <div>
                <p class="eyebrow">{{ offer.craftsmanName }}</p>
                <h3>{{ formatBudget(offer.offeredPrice) }}</h3>
                <p class="muted">
                  {{ 'ServiceRequestDetails.Offers.Estimated' | translate:{ minutes: offer.estimatedDurationMinutes } }}
                </p>
              </div>
              <span class="offer-status" [class]="getOfferStatusClass(offer.status)">
                {{ getOfferStatusLabel(offer.status) }}
              </span>
            </div>

            <p class="offer-description">{{ offer.description }}</p>

            <ul class="offer-meta">
              <li>
                <i class="bi bi-calendar2-week"></i>
                {{ 'ServiceRequestDetails.Offers.Availability' | translate:{ Day: formatDate(offer.preferredDate), Time: (offer.preferredTimeSlot) } }}
              </li>
              <li>
                <i class="bi bi-clock"></i>
                {{ 'ServiceRequestDetails.Offers.Sent' | translate:{ value: formatDateTime(offer.createdAt) } }}
              </li>
              <li *ngIf="offer.rejectionReason">
                <i class="bi bi-exclamation-circle"></i>
                {{ offer.rejectionReason }}
              </li>
            </ul>

            <div class="offer-actions" *ngIf="canManageOffer(offer)">
              <button
                type="button"
                class="primary-btn"
                (click)="acceptOffer(offer)"
                [disabled]="offerActionLoadingId() === offer.craftsmanOfferId"
              >
                <ng-container *ngIf="offerActionLoadingId() === offer.craftsmanOfferId; else acceptLabel">
                  {{ 'ServiceRequestDetails.Buttons.Processing' | translate }}
                </ng-container>
                <ng-template #acceptLabel>{{ 'ServiceRequestDetails.Buttons.AcceptOffer' | translate }}</ng-template>
              </button>

              <button type="button" class="ghost-btn" (click)="toggleRejectForm(offer)">
                <i class="bi bi-slash-circle"></i>
                {{ 'ServiceRequestDetails.Buttons.RejectOffer' | translate }}
              </button>
            </div>

            <div class="reject-panel" *ngIf="activeRejectOfferId() === offer.craftsmanOfferId">
              <label>
                <span>{{ 'ServiceRequestDetails.Reject.ReasonLabel' | translate }}</span>
                <textarea
                  rows="3"
                  [(ngModel)]="rejectReason"
                  [placeholder]="'ServiceRequestDetails.Reject.Placeholder' | translate"
                ></textarea>
              </label>
              <div class="reject-actions">
                <button type="button" class="ghost-btn" (click)="toggleRejectForm(offer)">{{ 'ServiceRequestDetails.Buttons.Cancel' | translate }}</button>
                <button
                  type="button"
                  class="danger-btn"
                  (click)="submitRejectOffer()"
                  [disabled]="offerActionLoadingId() === offer.craftsmanOfferId"
                >
                  <ng-container *ngIf="offerActionLoadingId() === offer.craftsmanOfferId; else rejectLabel">
                    {{ 'ServiceRequestDetails.Buttons.Processing' | translate }}
                  </ng-container>
                  <ng-template #rejectLabel>{{ 'ServiceRequestDetails.Buttons.SendRejection' | translate }}</ng-template>
                </button>
              </div>
            </div>
          </article>
        </div>
      </ng-container>
    </ng-template>

    <ng-template #noOffers>
      <div class="empty-panel">
        <div class="empty-icon">
          <i class="bi bi-envelope-open"></i>
        </div>
        <h3>{{ 'ServiceRequestDetails.Offers.EmptyTitle' | translate }}</h3>
        <p>{{ 'ServiceRequestDetails.Offers.EmptyDescription' | translate }}</p>
      </div>
    </ng-template>
  </section>

  <ng-container *ngIf="editModalOpen()">
    <div class="modal fade show" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <p class="eyebrow">{{ 'ServiceRequestDetails.Edit.Title' | translate }}</p>
              <h2 class="modal-title">{{ request()?.title }}</h2>
            </div>
            <!-- <button type="button" class="btn-close" aria-label="Close" (click)="closeEditModal()"></button> -->
          </div>

          <form class="modal-body modal-form" [formGroup]="editForm" (ngSubmit)="submitEdit()">
            <div class="form-grid">
              <label class="input-shell" [class.invalid]="editForm.get('title')?.invalid && (editForm.get('title')?.dirty || editForm.get('title')?.touched)">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.Title' | translate }}</span>
                <input type="text" formControlName="title" maxlength="80" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('description')?.invalid && (editForm.get('description')?.dirty || editForm.get('description')?.touched)">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.Description' | translate }}</span>
                <textarea rows="5" formControlName="description" maxlength="800"></textarea>
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('availableFromDate')?.invalid && editForm.get('availableFromDate')?.touched">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.AvailableFrom' | translate }}</span>
                <input type="date" formControlName="availableFromDate" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('availableToDate')?.invalid && editForm.get('availableToDate')?.touched">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.AvailableTo' | translate }}</span>
                <input type="date" formControlName="availableToDate" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('address')?.invalid && (editForm.get('address')?.dirty || editForm.get('address')?.touched)">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.Address' | translate }}</span>
                <input type="text" formControlName="address" maxlength="160" />
              </label>

              <label class="input-shell">
                <span>{{ 'ServiceRequestDetails.Edit.Fields.Budget' | translate }}</span>
                <input type="number" min="0" step="10" formControlName="customerBudget" />
              </label>
            </div>

            <p class="error-text" *ngIf="editError()">{{ editError() }}</p>

            <div class="modal-footer">
              <button type="button" class="btn btn-ghost" (click)="closeEditModal()" [disabled]="isSaving()">
                {{ 'ServiceRequestDetails.Buttons.Cancel' | translate }}
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="isSaving()">
                <ng-container *ngIf="isSaving(); else saveLabel">{{ 'ServiceRequestDetails.Buttons.Processing' | translate }}</ng-container>
                <ng-template #saveLabel>{{ 'ServiceRequestDetails.Buttons.SaveChanges' | translate }}</ng-template>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show"></div>
  </ng-container>

  <ng-container *ngIf="deleteModalOpen()">
    <div class="modal fade show" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <p class="eyebrow">{{ 'ServiceRequestDetails.Delete.Title' | translate }}</p>
              <h2 class="modal-title">{{ 'ServiceRequestDetails.Delete.Confirm' | translate }}</h2>
            </div>
            <!-- <button type="button" class="btn-close" aria-label="Close" (click)="cancelDelete()"></button> -->
          </div>
          <div class="modal-body">
            <p>{{ 'ServiceRequestDetails.Delete.Description' | translate }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-ghost" (click)="cancelDelete()" [disabled]="isDeletingRequest()">
              {{ 'ServiceRequestDetails.Buttons.Cancel' | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="isDeletingRequest()">
              <ng-container *ngIf="isDeletingRequest(); else deleteLabel">{{ 'ServiceRequestDetails.Buttons.Processing' | translate }}</ng-container>
              <ng-template #deleteLabel>{{ 'ServiceRequestDetails.Delete.Confirm' | translate }}</ng-template>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show"></div>
  </ng-container>
</div>
