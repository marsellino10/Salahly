<section class="requests-page">
  <header class="page-hero glass-panel">
    <div class="hero-copy">
      <p class="eyebrow">{{ 'ShowRequests.Hero.Eyebrow' | translate }}</p>
      <div class="hero-title">
        <h1>{{ 'ShowRequests.Hero.Title' | translate }}</h1>
        <span class="status-pill">
          <i class="bi bi-lightning-charge-fill"></i>
          {{ 'ShowRequests.Hero.TotalLabel' | translate:{ count: overviewStats().total } }}
        </span>
      </div>
      <p>{{ 'ShowRequests.Hero.Description' | translate }}</p>
      <div class="hero-actions">
        <button type="button" class="primary-btn rounded-5 me-2" routerLink="/service-request-form">
          <i class="bi bi-plus-lg"></i>
          {{ 'ShowRequests.Hero.NewRequestCta' | translate }}
        </button>
        <small class="muted">{{ 'ShowRequests.Hero.NewRequestHint' | translate }}</small>
      </div>
      <div class="stat-grid">
        <article class="stat-card">
          <p class="label">{{ 'ShowRequests.Hero.Stats.ActiveLabel' | translate }}</p>
          <p class="value">{{ overviewStats().active }}</p>
          <small>{{ 'ShowRequests.Hero.Stats.ActiveSubtitle' | translate }}</small>
        </article>
        <article class="stat-card">
          <p class="label">{{ 'ShowRequests.Hero.Stats.HistoryLabel' | translate }}</p>
          <p class="value">{{ overviewStats().history }}</p>
          <small>{{ 'ShowRequests.Hero.Stats.HistorySubtitle' | translate }}</small>
        </article>
        <article class="stat-card">
          <p class="label">{{ 'ShowRequests.Hero.Stats.BudgetLabel' | translate }}</p>
          <p class="value">{{ formatBudget(overviewStats().totalBudget) }}</p>
          <small>{{ 'ShowRequests.Hero.Stats.BudgetSubtitle' | translate }}</small>
        </article>
      </div>
    </div>
  </header>

  <div class="banner" *ngIf="actionBanner() as banner" [ngClass]="banner.type">
    <div>
      <p class="eyebrow">{{ 'ShowRequests.Banner.Title' | translate }}</p>
      <p>{{ banner.text }}</p>
    </div>
    <button type="button" class="ghost-btn" (click)="dismissActionBanner()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div *ngIf="errorMessage()" class="banner error">
    <div>
      <i class="bi bi-exclamation-triangle"></i>
      <span>{{ errorMessage() }}</span>
    </div>
    <button type="button" class="icon-btn" (click)="loadRequests()">
      <i class="bi bi-arrow-clockwise"></i>
      {{ 'ShowRequests.Buttons.Retry' | translate }}
    </button>
  </div>

  <div class="panel filters-panel glass-panel">
    <div class="tabs">
      <button type="button" class="tab-btn" [class.active]="activeTab() === 'active'" (click)="setTab('active')">
        {{ 'ShowRequests.Tabs.Active' | translate }}
        <span class="tab-pill">{{ overviewStats().active }}</span>
      </button>
      <button type="button" class="tab-btn" [class.active]="activeTab() === 'history'" (click)="setTab('history')">
        {{ 'ShowRequests.Tabs.History' | translate }}
        <span class="tab-pill">{{ overviewStats().history }}</span>
      </button>
    </div>

    <div class="filters">
      <label class="input-shell search">
        <i class="bi bi-search"></i>
        <input
          type="search"
          [placeholder]="'ShowRequests.Filters.SearchPlaceholder' | translate"
          [value]="searchTerm()"
          (input)="onSearch($any($event.target).value)"
        />
      </label>

      <label class="input-shell select">
        <span>{{ 'ShowRequests.Filters.StatusLabel' | translate }}</span>
        <select [value]="statusFilter()" (change)="onStatusFilterChange($any($event.target).value)">
          <option value="all">{{ 'ShowRequests.Filters.StatusAll' | translate }}</option>
          <option *ngFor="let status of statusOptions()" [value]="status">{{ getStatusLabel(status) }}</option>
        </select>
      </label>

      <label class="input-shell select">
        <span>{{ 'ShowRequests.Filters.AreaLabel' | translate }}</span>
        <select [value]="areaFilter()" (change)="onAreaFilterChange($any($event.target).value)">
          <option value="all">{{ 'ShowRequests.Filters.AreaAll' | translate }}</option>
          <option *ngFor="let area of uniqueAreas()" [value]="area">{{ area }}</option>
        </select>
      </label>

      <button type="button" class="icon-btn subtle" [disabled]="!hasActiveFilters()" (click)="clearFilters()">
        <i class="bi bi-sliders"></i>
        {{ 'ShowRequests.Filters.ClearButton' | translate }}
      </button>
    </div>
  </div>

  <section class="requests-grid">
    <div *ngIf="isLoading()" class="skeleton-grid">
      <article class="request-card skeleton" *ngFor="let _ of skeletonPlaceholders">
        <div class="card-head">
          <div class="skeleton-line w-60"></div>
          <div class="status-chip"></div>
        </div>
        <div class="skeleton-line w-90"></div>
        <div class="skeleton-line w-75"></div>
        <div class="skeleton-line w-50"></div>
        <div class="skeleton-pill"></div>
      </article>
    </div>

    <ng-container *ngIf="!isLoading()">
      <div *ngIf="filteredRequests().length; else emptyState" class="cards-grid">
        <article class="request-card" *ngFor="let request of filteredRequests(); trackBy: trackByRequestId">
          <div class="card-head">
            <div>
              <p class="eyebrow">{{ request.craftName || ('ShowRequests.Cards.Meta.CraftFallback' | translate) }}</p>
              <h3 data-bs-toggle="tooltip"
                data-bs-placement="top"
                [attr.title]="request.title">
                {{ request.title.length > 22 ? request.title.substring(0, 22)+'...' : request.title }}
              </h3>
            </div>
            <span
              class="status-chip"
              [style.background]="getStatusStyle(request.status).bg"
              [style.color]="getStatusStyle(request.status).text"
            >
              {{ getStatusLabel(request.status) }}
            </span>
          </div>

          <p class="description">{{ shortDescription(request.description) }}</p>

          <div class="meta">
            <div>
              <i class="bi bi-geo-alt"></i>
              {{ request.city || ('ShowRequests.Cards.Meta.CityFallback' | translate) }},
              {{ request.area || ('ShowRequests.Cards.Meta.AreaFallback' | translate) }}
            </div>
            <div>
              <i class="bi bi-calendar3"></i>
              {{ formatIso(request.availableFromDate) }} - {{ formatIso(request.availableToDate) || ('ShowRequests.Cards.Meta.DateFallback' | translate) }}            </div>
            <div>
              <i class="bi bi-currency-dollar"></i>
              {{ formatBudget(request.customerBudget) }}
            </div>
          </div>

          <div class="progress-panel" *ngIf="request.maxOffers">
            <div class="progress-meta">
              <span>{{ 'ShowRequests.Cards.Meta.OffersLabel' | translate }}</span>
              <span>{{ request.offersCount }}/{{ request.maxOffers }}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getOffersProgress(request)"></div>
            </div>
          </div>

          <div class="card-footer">
            <div class="dates">
              <small>{{ 'ShowRequests.Cards.Meta.CreatedLabel' | translate }} {{ formatIso(request.createdAt) }}</small>
              <small>{{ 'ShowRequests.Cards.Meta.ExpiresLabel' | translate }} {{ formatIso(request.expiresAt) }}</small>
            </div>
            <div class="card-actions">
              <div class="primary-actions">
                <button type="button" class="ghost-btn action-btn" (click)="openEditModal(request)">
                  <i class="bi bi-pencil-square"></i>
                  {{ 'ShowRequests.Cards.Actions.Edit' | translate }}
                </button>
                <button
                  type="button"
                  class="ghost-btn action-btn text-danger"
                  (click)="promptDelete(request.serviceRequestId)"
                  [disabled]="isDeleting() && deleteTargetId() === request.serviceRequestId"
                >
                  <i class="bi bi-trash"></i>
                  <ng-container *ngIf="isDeleting() && deleteTargetId() === request.serviceRequestId; else deleteLabel">
                    {{ 'ShowRequests.Buttons.Processing' | translate }}
                  </ng-container>
                  <ng-template #deleteLabel>{{ 'ShowRequests.Cards.Actions.Delete' | translate }}</ng-template>
                </button>
              </div>
              <button
                type="button"
                [routerLink]="['/service-request-details', request.serviceRequestId]"
                class="ghost-btn secondary-link"
              >
                {{ 'ShowRequests.Cards.Actions.ViewDetails' | translate }}
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
          </div>
        </article>
      </div>
    </ng-container>
  </section>

  <ng-template #emptyState>
    <div class="empty-panel glass-panel">
      <div class="empty-icon">
        <i class="bi" [class.bi-inboxes-fill]="activeTab() === 'history'" [class.bi-clipboard2-data]='activeTab() === "active"'></i>
      </div>
      <h3>
        {{
          (activeTab() === 'active'
            ? 'ShowRequests.Empty.ActiveTitle'
            : 'ShowRequests.Empty.HistoryTitle') | translate
        }}
      </h3>
      <p>
        {{
          activeTab() === 'active'
            ? ('ShowRequests.Empty.ActiveDescription' | translate)
            : ('ShowRequests.Empty.HistoryDescription' | translate)
        }}
      </p>
      <button type="button" class="primary-btn" (click)="loadRequests()">
        {{ 'ShowRequests.Empty.Refresh' | translate }}
      </button>
    </div>
  </ng-template>

  <ng-container *ngIf="editingRequest() as editing">
    <div class="modal fade show" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <p class="eyebrow">{{ 'ShowRequests.Edit.Title' | translate }}</p>
              <h2 class="modal-title">{{ editing.title }}</h2>
            </div>
            <button type="button" class="btn-close" aria-label="Close" (click)="closeEditModal()"></button>
          </div>

          <form class="modal-body modal-form" [formGroup]="editForm" (ngSubmit)="submitEdit()">
            <div class="form-grid">
              <label class="input-shell" [class.invalid]="editForm.get('title')?.invalid && (editForm.get('title')?.touched || editForm.get('title')?.dirty)">
                <span>{{ 'ShowRequests.Edit.Fields.Title' | translate }}</span>
                <input type="text" formControlName="title" maxlength="80" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('description')?.invalid && (editForm.get('description')?.touched || editForm.get('description')?.dirty)">
                <span>{{ 'ShowRequests.Edit.Fields.Description' | translate }}</span>
                <textarea rows="4" formControlName="description" maxlength="800"></textarea>
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('availableFromDate')?.invalid && editForm.get('availableFromDate')?.touched">
                <span>{{ 'ShowRequests.Edit.Fields.AvailableFrom' | translate }}</span>
                <input type="date" formControlName="availableFromDate" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('availableToDate')?.invalid && editForm.get('availableToDate')?.touched">
                <span>{{ 'ShowRequests.Edit.Fields.AvailableTo' | translate }}</span>
                <input type="date" formControlName="availableToDate" />
              </label>

              <label class="input-shell" [class.invalid]="editForm.get('address')?.invalid && (editForm.get('address')?.touched || editForm.get('address')?.dirty)">
                <span>{{ 'ShowRequests.Edit.Fields.Address' | translate }}</span>
                <input type="text" formControlName="address" maxlength="160" />
              </label>

              <label class="input-shell">
                <span>{{ 'ShowRequests.Edit.Fields.Budget' | translate }}</span>
                <input type="number" min="0" step="10" formControlName="customerBudget" />
              </label>
              <label class="input-shell">
                <span>{{ 'ShowRequests.Edit.Fields.paymentMethod' | translate }}</span>
                <select formControlName="paymentMethod">
                  <option *ngFor="let method of paymentMethods" [value]="method">{{ method }}</option>
                </select>
              </label>
            </div>

            <p class="error-text" *ngIf="editError()">{{ editError() }}</p>

            <div class="modal-footer">
              <button type="button" class="btn btn-ghost" (click)="closeEditModal()" [disabled]="isSaving()">
                {{ 'ShowRequests.Buttons.Cancel' | translate }}
              </button>
              <button type="submit" class="btn btn-primary" [disabled]="isSaving()">
                <ng-container *ngIf="isSaving(); else saveLabel">{{ 'ShowRequests.Buttons.Processing' | translate }}</ng-container>
                <ng-template #saveLabel>{{ 'ShowRequests.Buttons.Save' | translate }}</ng-template>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show"></div>
  </ng-container>

  <ng-container *ngIf="deleteTargetId()">
    <div class="modal fade show" tabindex="-1" style="display: block;" aria-modal="true" role="dialog">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <p class="eyebrow">{{ 'ShowRequests.Delete.Title' | translate }}</p>
              <h2 class="modal-title">{{ 'ShowRequests.Delete.Confirm' | translate }}</h2>
            </div>
            <!-- <button type="button" class="btn-close" aria-label="Close" (click)="cancelDelete()"></button> -->
          </div>
          <div class="modal-body">
            <p>{{ 'ShowRequests.Delete.Description' | translate }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-ghost" (click)="cancelDelete()" [disabled]="isDeleting()">
              {{ 'ShowRequests.Buttons.Cancel' | translate }}
            </button>
            <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="isDeleting()">
              <ng-container *ngIf="isDeleting(); else confirmLabel">{{ 'ShowRequests.Buttons.Processing' | translate }}</ng-container>
              <ng-template #confirmLabel>{{ 'ShowRequests.Delete.Confirm' | translate }}</ng-template>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show"></div>
  </ng-container>
</section>
